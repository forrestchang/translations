# 采样时间

### 问题

初学者的PID被设计为不定期调用。这导致2个问题：

- 您无法从PID中获得一致的行为，因为有时会频繁调用它，有时却不会。
- 您需要做额外的数学计算导数和积分，因为它们都取决于时间的变化。

### 解决方案

确保定期调用PID。我决定执行此操作的方法是指定每个周期调用一次计算函数。根据预定的采样时间，PID决定是应该立即计算还是返回。

一旦知道PID是以固定间隔进行评估的，则导数和积分计算也可以简化。奖金！

### 代码

现在在第10和11行，该算法自行决定是否该进行计算。另外，因为我们现在知道采样之间的时间是相同的，所以我们不需要不断地乘以时间变化。我们只能适当地调整Ki和Kd（第31和32行），结果在数学上是等效的，但效率更高。

虽然这样做有点皱纹。如果用户决定在操作期间更改采样时间，则需要重新调整Ki和Kd以反映此新更改。这就是第39-42行的全部内容。

还要注意，我在第29行将采样时间转换为秒。严格来说，这不是必需的，但是允许用户以1 / sec和s的单位而不是1 / mS和mS的形式输入Ki和Kd。

### 结果

上面的更改为我们做了三件事

1. 无论调用Compute（）的频率如何，PID算法都会以固定的间隔进行评估[第11行]
2. 由于时间相减[第10行]，当millis（）换回0时不会有任何问题。这只会每55天发生一次，但是我们要防弹吗？
3. 我们不再需要乘以和除以时间变化。由于它是一个常数，因此我们可以将其从计算代码中移出[15 + 16行]，并与调整常数[31 + 32行]融合在一起。从数学上讲，它的计算结果相同，但是每次对PID求值时都保存了乘法和除法运算

### 关于中断的旁注

如果此PID进入微控制器，则可以使用中断作为一个很好的论据。SetSampleTime设置中断频率，然后在时间到时调用Compute。在这种情况下，不需要9-12、23和24行。如果您打算通过PID强制执行此操作，那就去吧！不过请继续阅读本系列。希望您将从后续的修改中受益。  
我不使用中断的三个原因

1. 就本系列而言，并不是每个人都可以使用中断。
2. 如果您希望它同时实现许多PID控制器，事情将会变得棘手。
3. 老实说，这对我来说没有发生。 [吉米·罗杰斯](http://JimmiePRodgers.com)（[Jimmie Rodgers）](http://JimmiePRodgers.com)在为我校对该系列作品时提出了建议。我可能决定在PID库的将来版本中使用中断。

[下一个>>](2-derivative-kick.md)
